<meta charset="utf-8"> 
<META HTTP-EQUIV="CACHE-CONTROL" CONTENT="NO-CACHE">
<META HTTP-EQUIV="PRAGMA" CONTENT="NO-CACHE">
<META HTTP-EQUIV="EXPIRES" CONTENT="Mon, 22 Jul 2002 11:12:01 GMT">
<title>Callflows 13.6.22</title>
<style>
#i {
	float:left;
	border:3px inset gray;
	height:364px;
	width:300px; 
	font-size:14px;
	font-family:monospace;
	//position:fixed;
	z-index:1;
	//opacity:0.5;
	background-color:#FFF;
}
#t1 {
	float:left;
	border:3px inset gray;
	top:0;
	z-index:0;
}
.button {
	margin:5px;
	//float:right;
	text-align:center;
	width:100px;
	clear:both;
	border:3px outset gray;
	font-family:monospace;
	font-size:15px;
}
.button:active {
	border:3px inset gray;
}
.buttonbreak {
	height:1px;
	width:110px;
	border:3px outset gray;
}
#help {
	z-index:10000;
	padding:10px;
	border:3px inset gray; 
	background-color:#FFF;
	display:none;
	position:fixed;
	width:50%;
	height:50%;
	overflow:auto;
	top:25%;
	left:25%;
}
#help-bgr {
display:none;
z-index:9999;
width:100%;
height:100%;
opacity:0.6;
position:fixed;
top:0;
left:0;
}
</style>
<script src="raphael.js"></script>
<script src="themes.js"></script>
<script>
var paper,typenum=-1;
var conf=themes["defalut"];
var colsmade=[];
//from here to END1 the code is from:
//http://stackoverflow.com/questions/1229518/javascript-regex-replace-html-chars
var replaceHtmlEntites = (function() {
  var translate_re = /&(nbsp|amp|quot|lt|gt);/g;
  var translate = {
    "nbsp": " ", 
    "amp" : "&", 
    "quot": "\"",
    "lt"  : "<", 
    "gt"  : ">"
  };
  return function(s) {
    return ( s.replace(translate_re, function(match, entity) { 
      return translate[entity]; 
    }) );
  }
})();
//END1
//from here to END2 the code is from:
//http://stackoverflow.com/
if (!String.prototype.trim) String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g, '');};
String.prototype.ltrim=function(){return this.replace(/^\s+/,'');};
String.prototype.rtrim=function(){return this.replace(/\s+$/,'');};
//END2
//from here to END3 the code is from:
//http://stackoverflow.com/questions/11076975/insert-text-into-textarea-at-cursor-position-javascript
function insertAtCursor(myField, myValue/*added(*/,offset/*)*/) {
    /*added(*/if(!offset)offset=0/*)*/
    //IE support
    if (document.selection) {
        myField.focus();
        sel = document.selection.createRange();
        sel.text = myValue;
    }
    //MOZILLA and others
    else if (myField.selectionStart || myField.selectionStart == '0') {
        var startPos = myField.selectionStart;
        var endPos = myField.selectionEnd;
        myField.value = myField.value.substring(0, startPos)
            + myValue
            + myField.value.substring(endPos, myField.value.length);
	myField.selectionStart = startPos + myValue.length/*added(*/-offset/*)*/; 
	myField.selectionEnd = startPos + myValue.length/*added(*/-offset/*)*/;
    } else {
        myField.value += myValue;
    }
}
//END3
document.getElementsByAttribute = function(a,b)
{
	var output=[],j=0;;
	//from here to END4 the code is from:
	//http://stackoverflow.com/questions/8396541/javascript-to-get-elements-by-its-attribute
	var arr_elms = [];
	arr_elms = document.body.getElementsByTagName("*");
	var elms_len = arr_elms.length;
	for (var i = 0; i < elms_len; i++) {
		if(arr_elms[i].getAttribute(a) == b)//changed this line to suite my needs from:
		//if(arr_elms[i].getAttribute("someAttribute") != null)
		{
			output[j++]=arr_elms[i]//changed this line to suite my needs from:
			//alert("FOUND : " + arr_elms[i].getAttribute("someAttribute"));
		}
	}
	//END4
	return output;
}
String.prototype.ssplit=function(by)
{
	posDelimiter = this.indexOf(by);
	if(posDelimiter>0)return [this.substring(0, posDelimiter),this.substring(posDelimiter+by.length)];
	else return [this];
}
check = function()
{
	arrows[j][0]+=" ";
	arrows[j][1]+=" ";
	if(!colsmade[arrows[j][0]]&&arrows[j][0]!=null)
	{
		fline[m]=arrows[j][0];
		colsmade[fline[m]]=1;
		//x[fline[m]]=(m ? x[fline[m-1]]+conf.colspacing :(conf.margin+conf.cols.minlen)/2)
		m++;
	}
	if(!colsmade[arrows[j][1]]&&arrows[j][1]!=null)
	{
		fline[m]=arrows[j][1];
		colsmade[fline[m]]=1;
		//x[fline[m]]=(m ? x[fline[m-1]]+conf.colspacing :(conf.margin+conf.cols.minlen)/2)
		m++;
	}
}
check_note = function()
{
	arrows[j][1]+=" ";
	arrows[j][2]+=" ";
	if(!colsmade[arrows[j][1]]&&arrows[j][1]!=null)
	{
		fline[m]=arrows[j][1];
		//x[fline[m]]=(m ? x[fline[m-1]]+conf.colspacing :(conf.margin+conf.cols.minlen)/2)
		m++;
	}
	if(!colsmade[arrows[j][2]]&&arrows[j][2]!=null&&arrows[j][2]!="undefined ")
	{
		fline[m]=arrows[j][2];
		//x[fline[m]]=(m ? x[fline[m-1]]+conf.colspacing :(conf.margin+conf.cols.minlen)/2)
		m++;
	}
}
themeCheck=function(cust,def)
{
	var i=0;
	for(i in def)
	{
		if(!cust[i])cust[i]=def[i];
		else if(typeof(cust[i])==typeof(Object()))themeCheck(cust[i],def[i])
	}
}
draw = function(DOM)
{
	var conf=themes["defalut"];
	colsmade=[];
	inner=document.getElementById("i").value;
	if (window.sessionStorage)
	{
		//saving for later
		window.sessionStorage["commands"]=inner;
	}
	//typenum=(typenum+1)%conf.inputrefresh;;
	//if((e.keyCode? e.keyCode : e.charCode)<41&&(e.keyCode? e.keyCode : e.charCode)>36)return;
	//if((e.keyCode? e.keyCode : e.charCode)!=13&&typenum!=0)return;
	///if (e.altKey || e.ctrlKey || e.shiftKey)return;
	paper.clear();
	s="";
	s = replaceHtmlEntites(inner.replace(/<br>/gi,"\n"));
	arrCom = s.split("\n");
	for(i=0;i<arrCom.length;i++)if((arrCom[i]=arrCom[i].trim())==""){arrCom.splice(i-- , 1);};
	x=[];
	fline=[];
	arrows=[];
	j=0;
	m=0;
	title="";
	theme="defalut";
	for(i=0;i<arrCom.length;i++)
	{
		if(arrCom[i].match(/^\/\//));
		else if(arrCom[i].match(/^.+<->.+/))
		{
			arrows[j]=arrCom[i].ssplit("<->",2);
			arrows[j][1]=arrows[j][1].ssplit(":",2);
			arrows[j].splice(1,1,arrows[j][1][0],arrows[j][1][1]);
			if(!arrows[j][2])arrows[j][2]="";
			arrows[j][3]="double-arrow";
			arrows[j][4]=i;
			check();
			j++;
		}
		else if(arrCom[i].match(/^.+->.+/))
		{
			arrows[j]=arrCom[i].ssplit("->",2);
			//r=0;
			//if(!arrows[j][1].search(":"))r=1;
			arrows[j][1]=arrows[j][1].ssplit(":",2);
			arrows[j].splice(1,1,arrows[j][1][0],arrows[j][1][1]);
			if(!arrows[j][2])arrows[j][2]="";
			arrows[j][3]="arrow";
			arrows[j][4]=i;
			check();
			j++;
		}
		else if(arrCom[i].match(/^.+<>.+/))
		{
			arrows[j]=arrCom[i].ssplit("<>",2);
			arrows[j][1]=arrows[j][1].ssplit(":",2);
			arrows[j].splice(1,1,arrows[j][1][0],arrows[j][1][1]);
			if(!arrows[j][2])arrows[j][2]="";
			arrows[j][3]="double-arrow";
			arrows[j][4]=i;
			check();
			j++;
		}
		else if(arrCom[i].match(/^.+<-.+/))
		{
			arrows[j]=arrCom[i].ssplit("<-",2);
			arrows[j][1]=arrows[j][1].ssplit(":",2);
			arrows[j].splice(1,1,arrows[j][1][0],arrows[j][1][1]);
			if(!arrows[j][2])arrows[j][2]="";
			
			t=arrows[j][1];
			arrows[j][1]=arrows[j][0];
			arrows[j][0]=t;
			
			arrows[j][3]="arrow";
			arrows[j][4]=i;
			check();
			j++;
		}
		//----------------------------------------------
		else if(arrCom[i].match(/parallel[ ]*\{/))
		{
			arrows[j]=[];
			arrows[j][3]="parallel-start";
			arrows[j][4]=i;
			j++;
		}
		else if(arrCom[i].match(/}/))
		{
			arrows[j]=[];
			arrows[j][3]="parallel-stop";
			arrows[j][4]=i;
			j++;
		}
		//----------------------------------------------
		else if(arrCom[i].match(/note over .*\(/))
		{
			arrows[j]=[];
			arrows[j][0]="note";
			a=arrCom[i].ssplit("(")[0].trim().ssplit(",");
			if(a[1])
			{
				arrows[j][2]=a[1];
			}
			arrows[j][1]=a[0].replace(/note over/,"").trim();
			arrows[j][3]="note";
			arrows[j][4]=i;
			check_note();
			j++;
		}
		else if(arrCom[i].match(/.+\(/))
		{
			arrows[j]=[];
			arrows[j][0]=arrCom[i].ssplit("(")[0].trim().toUpperCase();
			arrows[j][3]="msg-start";
			arrows[j][4]=i;
			j++;
		}
		else if(arrCom[i].match(/^\)/))
		{
			arrows[j]=[];
			arrows[j][3]="msg-stop";
			arrows[j][4]=i;
			j++;
		}
		//----------------------------------------------
		else if(arrCom[i].match(/break/))
		{
			arrows[j]=[];
			arrows[j][2]=arrCom[i].ssplit(":")[1];
			arrows[j][3]="break";
			arrows[j][4]=i;
			j++;
		}
		//----------------------------------------------
		else if(arrCom[i].match(/title:/))
		{
			title=arrCom[i].ssplit(":")[1];
		}
		else if(arrCom[i].match(/theme:/))
		{
			theme=arrCom[i].ssplit(":")[1];
		}
	}
	arrows[j]=[0,0,"msg-stop",arrCom.length];
	conf=themes[theme];
	if(conf==undefined){conf=themes["defalut"];theme="defalut"}
	themeCheck(conf,themes["defalut"]);
	for(i in fline)
	{
		q=parseInt(i)
		x[fline[q]]=(q ? x[fline[q-1]]+conf.colspacing :(conf.margin+conf.cols.minlen)/2)
	}
	// at last we're drawing!!!-----------------------------
	for(i in x)
	{
		paper.rect(x[i]-conf.cols.minlen/2,20+(title?conf.titlesize:0),conf.cols.minlen,conf.cols.height,conf.cols.rectradius).attr("fill",conf.cols.fill);
		paper.text(x[i],5+conf.cols.height+(title?conf.titlesize:0),i).attr({"font-size":conf.txtsize,"fill":conf.cols.txtcolor});
	}
	y=conf.cols.height*2+10+(title?conf.titlesize:0);
	isParallel=0;
	n=0;
	breaks=[];
	for(i=0;i<arrows.length;i++)
	{
		//alert(y+"@"+i)
		b=1;
		if(arrows[i][3]=="arrow")
		{
			paper.path("M"+x[arrows[i][0]]+","+y+"L"+x[arrows[i][1]]+","+y).attr({"arrow-end":"block-wide-long","stroke-width":conf.strokewidth,"stroke":conf.strokecolor});
			BB=paper.text((x[arrows[i][0]]+x[arrows[i][1]])/2,y-conf.txtsize/2-2,arrows[i][2]).attr({"font-size":conf.txtsize,"fill":conf.txtcolor}).getBBox();
			paper.rect(BB.x,BB.y,BB.width,BB.height).attr({"stroke":"none","fill":conf.bgr}).toBack();
		}
		else if(arrows[i][3]=="double-arrow")
		{
			paper.path("M"+x[arrows[i][0]]+","+y+"L"+x[arrows[i][1]]+","+y).attr({"arrow-end":"block-wide-long","stroke-width":conf.strokewidth,"stroke":conf.strokecolor});
			paper.path("M"+x[arrows[i][1]]+","+y+"L"+x[arrows[i][0]]+","+y).attr({"arrow-end":"block-wide-long","stroke-width":conf.strokewidth,"stroke":conf.strokecolor});
			BB=paper.text((x[arrows[i][0]]+x[arrows[i][1]])/2,y-conf.txtsize/2-2,arrows[i][2]).attr({"font-size":conf.txtsize,"fill":conf.txtcolor}).getBBox();
			paper.rect(BB.x,BB.y,BB.width,BB.height).attr({"stroke":"none","fill":conf.bgr}).toBack();
		}
		else if(arrows[i][3]=="parallel-start")
		{
			isParallel=1;
		}
		else if(arrows[i][3]=="parallel-stop")
		{
			if(!isParallel)b=0;
			isParallel=0;
		}
		else if(arrows[i][3]=="msg-start"||arrows[i][3]=="note")
		{
			midx=0;
			ml=0;
			if(arrows[i][3]=="msg-start")
			{
				for(j=i;j>-1;j--)
				{
					if(arrows[j][3].match("arrow"))
					{
						midx=(x[arrows[j][0]]+x[arrows[j][1]])/2;
						break;
					}
				}
			}
			else if(x[arrows[i][2]])
			{
				midx=(x[arrows[i][1]]+x[arrows[i][2]])/2;
				ml=conf.colspacing;
			}
			else 
			{
				midx=x[arrows[i][1]];
			}
			if(!midx)continue;
			lasti=i;
			while(i<arrows.length&&arrows[i][3]!="msg-stop")
			{
				i++;
			}
			msg="";
			h=0;
			for(j=arrows[lasti][4]+1;j<arrows[((i==arrows.length)?i-1:i)][4];j++)
			{
				msg+=arrCom[j]+"\n";
				h+=conf.txtsize;
			}
			if(!conf.msg[arrows[lasti][0]])
			{
				conf.msg[arrows[lasti][0]]=conf.msg["_defalut"];
			}
			if(!msg)continue;
			t=paper.text(midx,y+h/2,msg).attr("font-size",conf.txtsize);
			BB=t.getBBox();
			if(!conf.msg[arrows[lasti][0]].align||conf.msg[arrows[lasti][0]].align=="left")t.attr({"x":BB.x,"text-anchor":"start"});
			else if(conf.msg[arrows[lasti][0]].align=="right")t.attr({"x":BB.x+BB.width,"text-anchor":"end"});
			paper.rect(BB.x-conf.msg[arrows[lasti][0]].margin,BB.y-conf.msg[arrows[lasti][0]].margin,BB.width+conf.msg[arrows[lasti][0]].margin*2,BB.height+conf.msg[arrows[lasti][0]].margin*2,conf.msg[arrows[lasti][0]].rectradius).attr("fill",conf.msg[arrows[lasti][0]].fill)
			iconname=(conf.msg[arrows[lasti][0]].noicon==0)?arrows[lasti][0]:"no-such";
			if(conf.msg[arrows[lasti][0]].noicon!=1)
			paper.image(iconname+"-icon.png",BB.x+BB.width-15,BB.y-conf.msg[arrows[lasti][0]].margin-4,33,20);
			t.toFront();
			y+=h+conf.txtsize;
		}
		else if(arrows[i][3]=="break")
		{
			breaks[n]=[];
			breaks[n][0]=y;
			breaks[n][1]=(arrows[i][2]?arrows[i][2]:"");
			n++;
		}
		else
		{
			b=0;
		}
		if(b&&!isParallel)y+=conf.linespacing;
	}
	y-=conf.linespacing-10;
	maxx=0;
	for(i in x)
	{
		maxx=Math.max(x[i],maxx);
		paper.path("M"+x[i]+","+y+"L"+x[i]+","+(20+(title?conf.titlesize:0))).attr("stroke",conf.strokecolor).toBack();
		paper.rect(x[i]-conf.cols.minlen/2,y,conf.cols.minlen,conf.cols.height,conf.cols.rectradius).attr("fill",conf.cols.fill);
		paper.text(x[i],y+conf.cols.height/2,i).attr({"font-size":conf.txtsize,"fill":conf.cols.txtcolor});
	}
	for(i in breaks)
	{
		paper.path("M"+(breaks[i][1]?0:conf.margin/2)+","+breaks[i][0]+"L"+(breaks[i][1]?(maxx+conf.margin):(maxx+conf.margin-conf.cols.minlen/2))+","+breaks[i][0]).attr({"stroke-dasharray":"--","stroke-width":conf.strokewidth,"stroke":conf.strokecolor});
		if(breaks[i][1])paper.text(10,breaks[i][0]-conf.txtsize/2,breaks[i][1]).attr({"font-size":conf.txtsize,"text-anchor":"start","fill":conf.txtcolor})
	}
	if(title)
	{
		paper.text((maxx+conf.margin)/2,10+conf.titlesize/2,title).attr({"font-size":conf.titlesize,"fill":conf.txtcolor});
	}
	paper.rect(0,0,maxx+conf.margin,y+(conf.cols.height+20)).attr({"fill":conf.bgr,"stroke-dasharray":"."}).toBack();
	document.getElementById("help-bgr").style.backgroundColor=conf.bgr;
	paper.setSize(maxx+conf.margin,y+(conf.cols.height+20))
}
window.onload = function()
{
	paper=Raphael("t1",0,0);
	if (window.sessionStorage&&window.sessionStorage["commands"])
	{
		//loading saved at line:~67
		document.getElementById("i").value=window.sessionStorage["commands"];
	}
	draw({keyCode:13});
	//refresh();
}
w = function(txt,b,offset)
{
	//document.getElementById("i").value+="\n"+txt;
	insertAtCursor(document.getElementById("i"),txt+"\n",offset)
	if(!b)draw();
}
help = function(b)
{
	document.getElementById("help-bgr").style.display=document.getElementById("help").style.display=b?"block":"none";
}
//<p id = 'i' contenteditable="true" spellcheck="false" language="en" onkeyup="draw(event)" >a->b:ttxt</p>
</script>
<div id="help-bgr"></div>
<div id="help">
<pre>
theme:(theme-name)
title:(title-text)
a-&gt;b[:text]
a&lt;&gt;b[:text]
a&lt;-b[:text]
note over a[,b] (
note body
)
msgType (
msg body
)
break[:text]
parallel {
code with arrows to be parallel
}
\\comment
</pre>
<div class="button" onclick="help(0)">hide</div>
</div>
<div style="float:left;border:3px inset gray;margin:0">
	<div class="button" onclick="w('title:title')">title</div>
	<div class="button" onclick="w('theme:defalut')">theme</div>
	<div class="button" onclick="w('a->b:text')">a-&gt;b:text</div>
	<div class="button" onclick="w('a<>b:text')">a&lt;&gt;b:text</div>
	<div class="button" onclick="w('a<-b:text')">a&lt;-b:text</div>
	<div class="button" onclick="w('//comment',1)">comment</div>
	<div class="button" onclick="w('note over a(\ntext\n)')">note</div>
	<div class="button" onclick="w('MSG (\ntext\n)')">msg</div>
	<div class="button" onclick="w('break:text')">break</div>
	<div class="button" onclick="w('parallel {\n\n}',0,3)">parallel</div>
	<div class="buttonbreak"></div>
	<div class="button" onclick="help(1)">help</div>
</div>
<textarea id = 'i' onchange="draw()" onkeyup="setTimeout(draw,100)" value="a->b:ttxt"></textarea>
<div id ='t1'></div>